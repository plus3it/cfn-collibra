{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Conditions": {
        "AssignInstanceRole": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "InstanceRoleName"
                        },
                        ""
                    ]
                }
            ]
        },
        "CreateAppVolume": {
            "Fn::Equals": [
                {
                    "Ref": "AppVolumeDevice"
                },
                "true"
            ]
        },
        "InstallCloudWatchAgent": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "CloudWatchAgentUrl"
                        },
                        ""
                    ]
                }
            ]
        },
        "InstallUpdates": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "NoUpdates"
                        },
                        "true"
                    ]
                }
            ]
        },
        "IsAgentServer": {
            "Fn::Equals": [
                {
                    "Ref": "CollibraDgcComponent"
                },
                "AGENT"
            ]
        },
        "IsConsoleServer": {
            "Fn::Equals": [
                {
                    "Ref": "CollibraDgcComponent"
                },
                "CONSOLE"
            ]
        },
        "IsDgcServer": {
            "Fn::Equals": [
                {
                    "Ref": "CollibraDgcComponent"
                },
                "DGC"
            ]
        },
        "IsJobServer": {
            "Fn::Equals": [
                {
                    "Ref": "CollibraDgcComponent"
                },
                "JOBSERVER"
            ]
        },
        "IsMonitoringServer": {
            "Fn::Equals": [
                {
                    "Ref": "CollibraDgcComponent"
                },
                "MONITORING"
            ]
        },
        "IsRepositoryServer": {
            "Fn::Equals": [
                {
                    "Ref": "CollibraDgcComponent"
                },
                "REPOSITORY"
            ]
        },
        "IsSearchServer": {
            "Fn::Equals": [
                {
                    "Ref": "CollibraDgcComponent"
                },
                "SEARCH"
            ]
        },
        "Reboot": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "NoReboot"
                        },
                        "true"
                    ]
                }
            ]
        },
        "SupportsNvme": {
            "Fn::Equals": [
                {
                    "Fn::FindInMap": [
                        "InstanceTypeMap",
                        {
                            "Ref": "InstanceType"
                        },
                        "SupportsNvme"
                    ]
                },
                "true"
            ]
        },
        "UseAdminGroups": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "WatchmakerAdminGroups"
                        },
                        ""
                    ]
                }
            ]
        },
        "UseAdminUsers": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "WatchmakerAdminUsers"
                        },
                        ""
                    ]
                }
            ]
        },
        "UseAmiFixer": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "AmiLocalizerScript"
                        },
                        ""
                    ]
                }
            ]
        },
        "UseBackupFolder": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "BackupFolder"
                        },
                        ""
                    ]
                }
            ]
        },
        "UseComputerName": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "WatchmakerComputerName"
                        },
                        ""
                    ]
                }
            ]
        },
        "UseEnvironment": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "WatchmakerEnvironment"
                        },
                        ""
                    ]
                }
            ]
        },
        "UseEpelRepo": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "EpelRepoName"
                        },
                        ""
                    ]
                }
            ]
        },
        "UseGroupKeyfile": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "AdminPubkeyURL"
                        },
                        ""
                    ]
                }
            ]
        },
        "UseKeyPair": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "KeyPairName"
                        },
                        ""
                    ]
                }
            ]
        },
        "UseOuPath": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "WatchmakerOuPath"
                        },
                        ""
                    ]
                }
            ]
        },
        "UseWamConfig": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "WatchmakerConfig"
                        },
                        ""
                    ]
                }
            ]
        }
    },
    "Description": "This template deploys the Collibra web-application onto a STIG-hardened EL7-based Linux instance",
    "Mappings": {
        "CollibraNodeType": {
            "AGENT": {
                "AddlFwPort": "",
                "FwPort": "4401",
                "SystemdSvc": "collibra-agent"
            },
            "CONSOLE": {
                "AddlFwPort": "",
                "FwPort": "4402",
                "SystemdSvc": "collibra-console"
            },
            "DGC": {
                "AddlFwPort": "",
                "FwPort": "4400",
                "SystemdSvc": "collibra-agent"
            },
            "JOBSERVER": {
                "AddlFwPort": "",
                "FwPort": "4404",
                "SystemdSvc": "collibra-agent"
            },
            "MONITORING": {
                "AddlFwPort": "",
                "FwPort": "4407",
                "SystemdSvc": "collibra-agent"
            },
            "REPOSITORY": {
                "AddlFwPort": "",
                "FwPort": "4403",
                "SystemdSvc": "collibra-agent"
            },
            "SEARCH": {
                "AddlFwPort": "4422",
                "FwPort": "4421",
                "SystemdSvc": "collibra-agent"
            }
        },
        "InstanceTypeMap": {
            "c4.large": {
                "SupportsNvme": "false"
            },
            "c4.xlarge": {
                "SupportsNvme": "false"
            },
            "c5.large": {
                "SupportsNvme": "true"
            },
            "c5.xlarge": {
                "SupportsNvme": "true"
            },
            "c5.2xlarge": {
                "SupportsNvme": "true"
            },
            "c5.4xlarge": {
                "SupportsNvme": "true"
            },
            "c5.8xlarge": {
                "SupportsNvme": "true"
            },
            "m4.large": {
                "SupportsNvme": "false"
            },
            "m4.xlarge": {
                "SupportsNvme": "false"
            },
            "m5.large": {
                "SupportsNvme": "true"
            },
            "m5.xlarge": {
                "SupportsNvme": "true"
            },
            "m5.2large": {
                "SupportsNvme": "true"
            },
            "m5.4xlarge": {
                "SupportsNvme": "true"
            },
            "m5.8xlarge": {
                "SupportsNvme": "true"
            },
            "r5.large": {
                "SupportsNvme": "true"
            },
            "r5.xlarge": {
                "SupportsNvme": "true"
            },
            "r5.2large": {
                "SupportsNvme": "true"
            },
            "r5.4xlarge": {
                "SupportsNvme": "true"
            },
            "r5.8xlarge": {
                "SupportsNvme": "true"
            },
            "t2.large": {
                "SupportsNvme": "false"
            },
            "t2.medium": {
                "SupportsNvme": "false"
            },
            "t2.micro": {
                "SupportsNvme": "false"
            },
            "t2.small": {
                "SupportsNvme": "false"
            },
            "t2.xlarge": {
                "SupportsNvme": "false"
            },
            "t3.large": {
                "SupportsNvme": "true"
            },
            "t3.medium": {
                "SupportsNvme": "true"
            },
            "t3.micro": {
                "SupportsNvme": "true"
            },
            "t3.small": {
                "SupportsNvme": "true"
            },
            "t3.xlarge": {
                "SupportsNvme": "true"
            }
        }
    },
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "EC2 Instance Configuration"
                    },
                    "Parameters": [
                        "AmiId",
                        "InstanceType",
                        "RootVolumeSize",
                        "ProvisionUser",
                        "KeyPairName",
                        "AdminPubkeyURL",
                        "InstanceRoleName",
                        "InstanceRoleProfile",
                        "SubnetId",
                        "SecurityGroupIds",
                        "NoReboot",
                        "NoUpdates"
                    ]
                },
                {
                    "Label": {
                        "default": "Application Storage"
                    },
                    "Parameters": [
                        "AppVolumeDevice",
                        "AppVolumeMountPath",
                        "AppVolumeSize",
                        "AppVolumeType"
                    ]
                },
                {
                    "Label": {
                        "default": "Application Configuration"
                    },
                    "Parameters": [
                        "CollibraInstallerUrl",
                        "CollibraDgcComponent",
                        "CollibraSoftwareDir",
                        "CollibraDataDir",
                        "CollibraConsolePassword",
                        "CollibraRepoPassword",
                        "EpelRepoName"
                    ]
                },
                {
                    "Label": {
                        "default": "Backup Configuration"
                    },
                    "Parameters": [
                        "BackupBucket",
                        "BackupSchedule",
                        "BackupScript",
                        "BackupUserName",
                        "BackupUserPassword"
                    ]
                },
                {
                    "Label": {
                        "default": "Watchmaker Configuration"
                    },
                    "Parameters": [
                        "PypiIndexUrl",
                        "WatchmakerConfig",
                        "WatchmakerEnvironment",
                        "WatchmakerOuPath",
                        "WatchmakerComputerName",
                        "WatchmakerAdminGroups",
                        "WatchmakerAdminUsers"
                    ]
                },
                {
                    "Label": {
                        "default": "CloudFormation Configuration"
                    },
                    "Parameters": [
                        "CloudWatchAgentUrl"
                    ]
                }
            ]
        },
        "Version": "1.4.3"
    },
    "Outputs": {
        "CollibraHostLogGroupName": {
            "Condition": "InstallCloudWatchAgent",
            "Description": "Log Group Name",
            "Value": {
                "Ref": "CollibraLogGroup"
            }
        },
        "InstanceAz": {
            "Description": "Availability-zone hosting the instance",
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-InstanceAz"
                }
            },
            "Value": {
                "Fn::GetAtt": [
                    "CollibraHost",
                    "AvailabilityZone"
                ]
            }
        },
        "InstanceId": {
            "Description": "Instance ID",
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-InstanceID"
                }
            },
            "Value": {
                "Ref": "CollibraHost"
            }
        },
        "InstancePrivateIPv4": {
            "Description": "Instance private IPv4 IP address",
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-InstancePrivateIPv4"
                }
            },
            "Value": {
                "Fn::GetAtt": [
                    "CollibraHost",
                    "PrivateIp"
                ]
            }
        }
    },
    "Parameters": {
        "AmiLocalizerScript": {
            "AllowedPattern": "^$|^(http[s]?|s3)://.*$",
            "Description": "Script to set EC2 to a 'known-good' starting-point",
            "Type": "String"
        },
        "AdminPubkeyURL": {
            "AllowedPattern": "^http[s]?://.*|^$",
            "Description": "(Optional) URL of file containing admin group's SSH public-keys",
            "Type": "String"
        },
        "AmiId": {
            "AllowedPattern": "^ami-[0-9a-z]{8}$|^ami-[0-9a-z]{17}$",
            "Description": "ID of the AMI to launch",
            "Type": "AWS::EC2::Image::Id"
        },
        "AppVolumeDevice": {
            "AllowedValues": [
                "true",
                "false"
            ],
            "Default": "false",
            "Description": "Decision on whether to mount an extra EBS volume. Leave as default (\"false\") to launch without an extra application volume",
            "Type": "String"
        },
        "AppVolumeMountPath": {
            "AllowedPattern": "/.*",
            "Default": "/opt/collibra",
            "Description": "Filesystem path to mount the extra app volume. Ignored if \"AppVolumeDevice\" is false",
            "Type": "String"
        },
        "AppVolumeSize": {
            "ConstraintDescription": "Must be between 1GB and 16384GB.",
            "Default": "1",
            "Description": "Size in GB of the EBS volume to create. Ignored if \"AppVolumeDevice\" is false",
            "MaxValue": "16384",
            "MinValue": "1",
            "Type": "Number"
        },
        "AppVolumeType": {
            "AllowedValues": [
                "gp2",
                "io1",
                "sc1",
                "st1",
                "standard"
            ],
            "Default": "gp2",
            "Description": "Type of EBS volume to create. Ignored if \"AppVolumeDevice\" is false",
            "Type": "String"
        },
        "BackupBucket": {
            "Description": "(Optional: Only used if \"CollibraDgcComponent\" is set to \"CONSOLE\") Name of the S3 bucket in which to store Collibra backups",
            "Type": "String"
        },
        "BackupSchedule": {
            "Default": "45 0 * * *",
            "Description": "(Optional: Only used if \"CollibraDgcComponent\" is set to \"CONSOLE\") When to run backups via Linux cron system (use \"cronie\" cron-format)",
            "Type": "String"
        },
        "BackupScript": {
            "Description": "(Optional: Only used if \"CollibraDgcComponent\" is set to \"CONSOLE\") S3-hosted location backup script",
            "Type": "String"
        },
        "BackupUserName": {
            "Description": "(Optional: Only used if \"CollibraDgcComponent\" is set to \"CONSOLE\") User-name (inside the Collibra console) with permissions to run backup jobs",
            "Type": "String"
        },
        "BackupUserPassword": {
            "Description": "(Optional: Only used if \"CollibraDgcComponent\" is set to \"CONSOLE\") Password of user (inside the Collibra console) with permissions to run backup jobs",
            "Type": "String"
        },
        "CfnInitUrl": {
            "AllowedPattern": "^http[s]?://.*$",
            "Default": "https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-py3-latest.tar.gz",
            "Description": "URL to the pip-installable aws-cfn-bootstrap package",
            "Type": "String"
        },
        "CloudWatchAgentUrl": {
            "AllowedPattern": "^$|^s3://.*$",
            "Default": "",
            "Description": "(Optional) S3 URL to CloudWatch Agent installer. Example: s3://amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip",
            "Type": "String"
        },
        "CollibraConsolePassword": {
            "AllowedPattern": "^[a-zA-Z0-9]{8,12}$",
            "Description": "Password to link the Collibra DGC and Console services",
            "NoEcho": "True",
            "Type": "String"
        },
        "CollibraDataDir": {
            "AllowedPattern": "/.*",
            "Default": "/opt/collibra/data",
            "Description": "Location where Collibra application-data should be rooted",
            "Type": "String"
        },
        "CollibraDgcComponent": {
            "AllowedValues": [
                "AGENT",
                "CONSOLE",
                "DGC",
                "JOBSERVER",
                "MONITORING",
                "REPOSITORY",
                "SEARCH"
            ],
            "Description": "Which Collibra element to deploy",
            "Type": "String"
        },
        "CollibraInstallerUrl": {
            "AllowedPattern": "^$|^s3://.*$",
            "Default": "",
            "Description": "URL from which to download the Collibra installer SHAR-file",
            "Type": "String"
        },
        "CollibraRepoPassword": {
            "AllowedPattern": "^[a-zA-Z0-9]{8,12}$",
            "Description": "Password to use for accessing the Repository database",
            "NoEcho": "True",
            "Type": "String"
        },
        "CollibraSoftwareDir": {
            "AllowedPattern": "/.*",
            "Default": "/opt/collibra/software",
            "Description": "Location where Collibra application-software should be rooted",
            "Type": "String"
        },
        "EpelRepoName": {
            "Default": "epel",
            "Description": "Name of yum repository from which to pull extra RPMs.",
            "Type": "String"
        },
        "InstanceRoleName": {
            "Default": "",
            "Description": "(Optional) IAM instance role-name to use for signalling",
            "Type": "String"
        },
        "InstanceRoleProfile": {
            "Default": "",
            "Description": "(Optional) IAM instance profile-name to apply to the instance",
            "Type": "String"
        },
        "InstanceType": {
            "AllowedValues": [
                "t2.micro",
                "t2.small",
                "t2.medium",
                "t2.large",
                "t2.xlarge",
                "t3.micro",
                "t3.small",
                "t3.medium",
                "t3.large",
                "t3.xlarge",
                "c4.large",
                "c4.xlarge",
                "m4.large",
                "m4.xlarge",
                "c5.large",
                "c5.xlarge",
                "c5.2xlarge",
                "c5.4xlarge",
                "c5.9xlarge",
                "m5.large",
                "m5.xlarge",
                "m5.2xlarge",
                "m5.4xlarge",
                "m5.8xlarge",
                "r5.large",
                "r5.xlarge",
                "r5.2xlarge",
                "r5.4xlarge",
                "r5.8xlarge"
            ],
            "Default": "t2.micro",
            "Description": "Amazon EC2 instance type",
            "Type": "String"
        },
        "KeyPairName": {
            "Description": "(Optional) Public/private key pairs allow you to securely connect to your instance after it launches",
            "Type": "String"
        },
        "NoReboot": {
            "AllowedValues": [
                "false",
                "true"
            ],
            "Default": "false",
            "Description": "Controls whether to reboot the instance as the last step of cfn-init execution",
            "Type": "String"
        },
        "NoUpdates": {
            "AllowedValues": [
                "false",
                "true"
            ],
            "Default": "false",
            "Description": "Controls whether to run yum update during a stack update (on the initial instance launch, Watchmaker _always_ installs updates)",
            "Type": "String"
        },
        "ProvisionUser": {
            "AllowedPattern": "[a-z0-9-]{6,12}+",
            "ConstraintDescription": "Alphanumeric string between 6 and 12 characters.",
            "Default": "ec2-user",
            "Description": "Default login user account name",
            "Type": "String"
        },
        "PypiIndexUrl": {
            "AllowedPattern": "^http[s]?://.*$",
            "Default": "https://pypi.org/simple",
            "Description": "URL to the PyPi Index",
            "Type": "String"
        },
        "RootVolumeSize": {
            "ConstraintDescription": "Must be between 20GB and 16384GB.",
            "Default": "20",
            "Description": "Size in GB of the EBS volume to create. Ignored if \"AppVolumeDevice\" is blank",
            "MaxValue": "16384",
            "MinValue": "20",
            "Type": "Number"
        },
        "SecurityGroupIds": {
            "Description": "List of security groups to apply to the instance",
            "Type": "List<AWS::EC2::SecurityGroup::Id>"
        },
        "SubnetId": {
            "Description": "ID of the subnet to assign to the instance",
            "Type": "AWS::EC2::Subnet::Id"
        },
        "WatchmakerAdminGroups": {
            "Default": "",
            "Description": "(Optional) Colon-separated list of domain groups that should have admin permissions on the EC2 instance",
            "Type": "String"
        },
        "WatchmakerAdminUsers": {
            "Default": "",
            "Description": "(Optional) Colon-separated list of domain users that should have admin permissions on the EC2 instance",
            "Type": "String"
        },
        "WatchmakerComputerName": {
            "Default": "",
            "Description": "(Optional) Sets the hostname/computername within the OS",
            "Type": "String"
        },
        "WatchmakerConfig": {
            "AllowedPattern": "^$|^(http[s]?|s3|file)://.*$",
            "Default": "",
            "Description": "(Optional) Path to a Watchmaker config file.  The config file path can be a remote source (i.e. http[s]://, s3://) or local directory (i.e. file://)",
            "Type": "String"
        },
        "WatchmakerEnvironment": {
            "AllowedValues": [
                "",
                "dev",
                "test",
                "prod"
            ],
            "Default": "",
            "Description": "Environment in which the instance is being deployed",
            "Type": "String"
        },
        "WatchmakerOuPath": {
            "AllowedPattern": "^$|^(OU=.+,)+(DC=.+)+$",
            "Default": "",
            "Description": "(Optional) DN of the OU to place the instance when joining a domain. If blank and \"WatchmakerEnvironment\" enforces a domain join, the instance will be placed in a default container. Leave blank if not joining a domain, or if \"WatchmakerEnvironment\" is \"false\"",
            "Type": "String"
        }
    },
    "Resources": {
        "CollibraHost": {
            "CreationPolicy": {
                "ResourceSignal": {
                    "Count": "1",
                    "Timeout": "PT60M"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Authentication": {
                    "S3AccessCreds": {
                        "buckets": [
                            {
                                "Ref": "BackupBucket"
                            }
                        ],
                        "roleName": {
                            "Ref": "InstanceRoleName"
                        },
                        "type": "S3"
                    }
                },
                "AWS::CloudFormation::Init": {
                    "admkey-install": {
                        "commands": {
                            "1-install-keyfile": {
                                "command": "bash -xe /etc/cfn/scripts/admkey.sh"
                            }
                        },
                        "files": {
                            "/etc/cfn/files/AdminKeys.pub": {
                                "group": "root",
                                "mode": "000600",
                                "owner": "root",
                                "source": {
                                    "Ref": "AdminPubkeyURL"
                                }
                            },
                            "/etc/cfn/scripts/admkey.sh": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "#!/bin/bash\n\n",
                                            "PROVHOME=$(getent passwd ",
                                            {
                                                "Ref": "ProvisionUser"
                                            },
                                            " | awk -F\":\" '{print $6}')\n",
                                            "\n",
                                            "install -b -m 000600 -o ",
                                            {
                                                "Ref": "ProvisionUser"
                                            },
                                            " -g ",
                                            {
                                                "Ref": "ProvisionUser"
                                            },
                                            " /etc/cfn/files/AdminKeys.pub ${PROVHOME}/.ssh/authorized_keys\n",
                                            "\n"
                                        ]
                                    ]
                                },
                                "group": "root",
                                "mode": "000700",
                                "owner": "root"
                            }
                        }
                    },
                    "collibrainstall": {
                        "commands": {
                            "01-get-collibra-installer": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "install -Dbm 000755 -o root -g root /dev/null",
                                            " /etc/cfn/files/dgc-linux-installer.sh &&",
                                            " aws s3 cp ",
                                            {
                                                "Ref": "CollibraInstallerUrl"
                                            },
                                            " - > /etc/cfn/files/dgc-linux-installer.sh\n"
                                        ]
                                    ]
                                }
                            },
                            "02-relax-tmp": {
                                "command": "mountpoint /tmp || true && mount -o remount,exec /tmp",
                                "ignoreErrors": "true"
                            },
                            "03-relax-selinux": {
                                "command": "setenforce 0"
                            },
                            "04-precreate-user": {
                                "command": "useradd -s /bin/true collibra"
                            },
                            "05A-set-file-descriptor-max": {
                                "command": "ulimit -n 65536 && echo '*     soft   nofile  1024\n*     hard   nofile  65536' >> /etc/security/limits.conf"
                            },
                            "05B-set-nproc-max": {
                                "command": "ulimit -u 4096 && echo '*     soft   nproc  4096\n*     hard   nproc  4096' >> /etc/security/limits.conf"
                            },
                            "05C-set-fsize-limit": {
                                "command": "ulimit -f unlimited && echo '*     soft   fsize  unlimited\n*     hard   fsize  unlimited' >> /etc/security/limits.conf"
                            },
                            "05D-set-as-limit": {
                                "command": "ulimit -v unlimited && echo '*     soft   as  unlimited\n*     hard   as  unlimited' >> /etc/security/limits.conf"
                            },
                            "05E-set-mmap-limit": {
                                "command": "sysctl -w vm.max_map_count=262144 && echo '# set mmap value for Collibra/ElasticSearch\nvm.max_map_count=262144' >> /etc/sysctl.conf"
                            },
                            "05F-runinstaller": {
                                "command": "bash -xe /etc/cfn/files/collibra-wrapper.sh"
                            },
                            "06-enable-service": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "systemctl enable ",
                                            {
                                                "Fn::FindInMap": [
                                                    "CollibraNodeType",
                                                    {
                                                        "Ref": "CollibraDgcComponent"
                                                    },
                                                    "SystemdSvc"
                                                ]
                                            },
                                            "\n"
                                        ]
                                    ]
                                }
                            },
                            "07-open-firewall-port": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "firewall-cmd --add-port=",
                                            {
                                                "Fn::FindInMap": [
                                                    "CollibraNodeType",
                                                    {
                                                        "Ref": "CollibraDgcComponent"
                                                    },
                                                    "FwPort"
                                                ]
                                            },
                                            "/tcp --permanent\n",
                                            "firewall-cmd --add-port=4401/tcp --permanent\n"
                                        ]
                                    ]
                                }
                            },
                            "07A-open-addl-firewall-port": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Fn::If": [
                                                    "IsSearchServer",
                                                    {
                                                        "Fn::Join": [
                                                            "",
                                                            [
                                                                "firewall-cmd --add-port=",
                                                                {
                                                                    "Fn::FindInMap": [
                                                                        "CollibraNodeType",
                                                                        {
                                                                            "Ref": "CollibraDgcComponent"
                                                                        },
                                                                        "AddlFwPort"
                                                                    ]
                                                                },
                                                                "/tcp --permanent\n"
                                                            ]
                                                        ]
                                                    },
                                                    "echo 'Not a search server, no additional FW port\n'"
                                                ]
                                            }
                                        ]
                                    ]
                                }
                            }
                        },
                        "files": {
                            "/etc/cfn/files/collibra-wrapper.sh": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "#!/bin/bash\n",
                                            "export SHELL=/bin/bash\n",
                                            "export HOME=/root\n",
                                            "export USERNAME=root\n",
                                            "export TERM=vt100\n",
                                            "\n",
                                            "source /etc/profile\n",
                                            "source /root/.bash_profile\n",
                                            "\n",
                                            "umask 022\n",
                                            "\n",
                                            "/etc/cfn/files/dgc-linux-installer.sh -- -c /etc/cfn/files/collibra.answer.json\n"
                                        ]
                                    ]
                                },
                                "group": "root",
                                "mode": "000755",
                                "owner": "root"
                            },
                            "/etc/cfn/files/collibra.answer.json": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "{\n",
                                            "    \"installationDirectory\": \"",
                                            {
                                                "Ref": "CollibraSoftwareDir"
                                            },
                                            "\",\n",
                                            "    \"dataDirectory\": \"",
                                            {
                                                "Ref": "CollibraDataDir"
                                            },
                                            "\",\n",
                                            {
                                                "Fn::If": [
                                                    "IsDgcServer",
                                                    {
                                                        "Fn::Join": [
                                                            "",
                                                            [
                                                                "    \"repoDgcPassword\": \"",
                                                                {
                                                                    "Ref": "CollibraConsolePassword"
                                                                },
                                                                "\",\n",
                                                                "    \"dgcMinMemory\": 1024,\n",
                                                                "    \"dgcMaxMemory\": 2048,\n",
                                                                "    \"dgcPort\": 4400,\n",
                                                                "    \"dgcShutdownPort\": 4430,\n",
                                                                "    \"dgcContextPath\": \"\",\n"
                                                            ]
                                                        ]
                                                    },
                                                    {
                                                        "Ref": "AWS::NoValue"
                                                    }
                                                ]
                                            },
                                            {
                                                "Fn::If": [
                                                    "IsConsoleServer",
                                                    {
                                                        "Fn::Join": [
                                                            "",
                                                            [
                                                                "    \"consolePort\": 4402,\n",
                                                                "    \"consoleContextPath\": \"\",\n"
                                                            ]
                                                        ]
                                                    },
                                                    {
                                                        "Ref": "AWS::NoValue"
                                                    }
                                                ]
                                            },
                                            {
                                                "Fn::If": [
                                                    "IsSearchServer",
                                                    {
                                                        "Fn::Join": [
                                                            "",
                                                            [
                                                                "    \"searchHttpPort\": 4421,\n",
                                                                "    \"searchTransportPort\": 4422,\n",
                                                                "    \"searchMemory\": 2048,\n"
                                                            ]
                                                        ]
                                                    },
                                                    {
                                                        "Ref": "AWS::NoValue"
                                                    }
                                                ]
                                            },
                                            {
                                                "Fn::If": [
                                                    "IsJobServer",
                                                    {
                                                        "Fn::Join": [
                                                            "",
                                                            [
                                                                "    \"jobserverDatabasePort\": 4414,\n",
                                                                "    \"jobserverMonitoringPort\": 4424,\n",
                                                                "    \"jobserverPort\": 4404,\n"
                                                            ]
                                                        ]
                                                    },
                                                    {
                                                        "Ref": "AWS::NoValue"
                                                    }
                                                ]
                                            },
                                            {
                                                "Fn::If": [
                                                    "IsMonitoringServer",
                                                    "    \"monitoringPort\": 4407,\n",
                                                    {
                                                        "Ref": "AWS::NoValue"
                                                    }
                                                ]
                                            },
                                            {
                                                "Fn::If": [
                                                    "IsRepositoryServer",
                                                    {
                                                        "Fn::Join": [
                                                            "",
                                                            [
                                                                "    \"repositoryMemory\": 1024,\n",
                                                                "    \"repositoryPort\": 4403,\n",
                                                                "    \"repoAdminPassword\": \"",
                                                                {
                                                                    "Ref": "CollibraRepoPassword"
                                                                },
                                                                "\",\n"
                                                            ]
                                                        ]
                                                    },
                                                    {
                                                        "Ref": "AWS::NoValue"
                                                    }
                                                ]
                                            },
                                            {
                                                "Fn::If": [
                                                    "IsAgentServer",
                                                    "    \"agentPort\": 4401,\n",
                                                    {
                                                        "Ref": "AWS::NoValue"
                                                    }
                                                ]
                                            },
                                            "    \"initDaemon\": \"SYSTEMD\",\n",
                                            "    \"componentSet\": [ \"",
                                            {
                                                "Ref": "CollibraDgcComponent"
                                            },
                                            "\" ]\n",
                                            "}\n"
                                        ]
                                    ]
                                },
                                "group": "root",
                                "mode": "000600",
                                "owner": "root"
                            }
                        }
                    },
                    "configSets": {
                        "launch": [
                            "setup",
                            {
                                "Fn::If": [
                                    "UseGroupKeyfile",
                                    "admkey-install",
                                    {
                                        "Ref": "AWS::NoValue"
                                    }
                                ]
                            },
                            {
                                "Fn::If": [
                                    "InstallCloudWatchAgent",
                                    "cw-agent-install",
                                    {
                                        "Ref": "AWS::NoValue"
                                    }
                                ]
                            },
                            "watchmaker-install",
                            "watchmaker-launch",
                            "collibrainstall",
                            {
                                "Fn::If": [
                                    "IsConsoleServer",
                                    "configureBackups",
                                    {
                                        "Ref": "AWS::NoValue"
                                    }
                                ]
                            },
                            "finalize",
                            {
                                "Fn::If": [
                                    "Reboot",
                                    "reboot",
                                    {
                                        "Ref": "AWS::NoValue"
                                    }
                                ]
                            }
                        ],
                        "update": [
                            "setup",
                            {
                                "Fn::If": [
                                    "UseGroupKeyfile",
                                    "admkey-install",
                                    {
                                        "Ref": "AWS::NoValue"
                                    }
                                ]
                            },
                            {
                                "Fn::If": [
                                    "InstallUpdates",
                                    "install-updates",
                                    {
                                        "Ref": "AWS::NoValue"
                                    }
                                ]
                            },
                            "watchmaker-install",
                            "watchmaker-update",
                            "collibrainstall",
                            {
                                "Fn::If": [
                                    "IsConsoleServer",
                                    "configureBackups",
                                    {
                                        "Ref": "AWS::NoValue"
                                    }
                                ]
                            },
                            "finalize",
                            {
                                "Fn::If": [
                                    "Reboot",
                                    "reboot",
                                    {
                                        "Ref": "AWS::NoValue"
                                    }
                                ]
                            }
                        ]
                    },
                    "configureBackups": {
                        "commands": {
                            "01-download-bkup-cron": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "install -Dbm 000755 -o root -g root /dev/null",
                                            " /usr/local/sbin/collibra-bkup.sh &&",
                                            " curl -kL ",
                                            {
                                                "Ref": "BackupScript"
                                            },
                                            " -o /usr/local/sbin/collibra-bkup.sh\n"
                                        ]
                                    ]
                                }
                            },
                            "02-install-jq": {
                                "command": {
                                    "Fn::If": [
                                        "UseEpelRepo",
                                        {
                                            "Fn::Join": [
                                                "",
                                                [
                                                    "yum install -y --enablerepo=",
                                                    {
                                                        "Ref": "EpelRepoName"
                                                    },
                                                    " jq\n",
                                                    "\n"
                                                ]
                                            ]
                                        },
                                        "yum install -y jq\n"
                                    ]
                                },
                                "ignoreErrors": "true"
                            }
                        },
                        "files": {
                            "/etc/cron.d/backup-collibra": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "# Backup Collibra directly to S3\n",
                                            "#\n",
                                            "################################\n",
                                            "ADMIN=",
                                            {
                                                "Ref": "BackupUserName"
                                            },
                                            "\n",
                                            "PASSWD=",
                                            {
                                                "Ref": "BackupUserPassword"
                                            },
                                            "\n",
                                            "S3BUCKET=",
                                            {
                                                "Ref": "BackupBucket"
                                            },
                                            "\n",
                                            "\n",
                                            {
                                                "Ref": "BackupSchedule"
                                            },
                                            " root /usr/local/sbin/collibra-bkup.sh > /dev/null 2>&1\n"
                                        ]
                                    ]
                                },
                                "group": "root",
                                "mode": "000644",
                                "owner": "root"
                            }
                        }
                    },
                    "cw-agent-install": {
                        "commands": {
                            "01-get-cloudwatch-agent": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "install -Dbm 700 -o root -g root /dev/null /etc/cfn/scripts/AmazonCloudWatchAgent.rpm &&",
                                            " aws s3 cp ",
                                            {
                                                "Ref": "CloudWatchAgentUrl"
                                            },
                                            " /etc/cfn/scripts/AmazonCloudWatchAgent.rpm"
                                        ]
                                    ]
                                }
                            },
                            "02-install-cloudwatch-agent": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "yum -y --nogpgcheck install /etc/cfn/scripts/AmazonCloudWatchAgent.rpm &&",
                                            " /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl",
                                            " -a fetch-config -m ec2 -c",
                                            " file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json -s"
                                        ]
                                    ]
                                }
                            }
                        },
                        "files": {
                            "/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json": {
                                "content": {
                                    "Fn::If": [
                                        "InstallCloudWatchAgent",
                                        {
                                            "Fn::Join": [
                                                "",
                                                [
                                                    "{",
                                                    "  \"logs\": {\n",
                                                    "  \"logs_collected\": {\n",
                                                    "    \"files\": {\n",
                                                    "    \"collect_list\": [\n",
                                                    "      {\n",
                                                    "      \"file_path\": \"/opt/aws/amazon-cloudwatch-agent/logs/amazon-cloudwatch-agent.log\",\n",
                                                    "      \"log_group_name\": \"",
                                                    {
                                                        "Ref": "CollibraLogGroup"
                                                    },
                                                    "\",\n",
                                                    "      \"log_stream_name\": \"cloudwatch_agent_logs_{instance_id}\",\n",
                                                    "      \"timestamp_format\": \"%H:%M:%S %y %b %-d\"\n",
                                                    "      },\n",
                                                    "      {\n",
                                                    "      \"file_path\": \"/var/log/cfn-init.log\",\n",
                                                    "      \"log_group_name\": \"",
                                                    {
                                                        "Ref": "CollibraLogGroup"
                                                    },
                                                    "\",\n",
                                                    "      \"log_stream_name\": \"cfn_init_logs_{instance_id}\",\n",
                                                    "      \"timestamp_format\": \"%H:%M:%S %y %b %-d\"\n",
                                                    "      },\n",
                                                    "      {\n",
                                                    "      \"file_path\": \"/var/log/messages\",\n",
                                                    "      \"log_group_name\": \"",
                                                    {
                                                        "Ref": "CollibraLogGroup"
                                                    },
                                                    "\",\n",
                                                    "      \"log_stream_name\": \"messages_logs_{instance_id}\",\n",
                                                    "      \"timestamp_format\": \"%H:%M:%S %y %b %-d\"\n",
                                                    "      },\n",
                                                    "      {\n",
                                                    "      \"file_path\": \"/var/log/secure\",\n",
                                                    "      \"log_group_name\": \"",
                                                    {
                                                        "Ref": "CollibraLogGroup"
                                                    },
                                                    "\",\n",
                                                    "      \"log_stream_name\": \"os_security_logs_{instance_id}\",\n",
                                                    "      \"timestamp_format\": \"%H:%M:%S %y %b %-d\"\n",
                                                    "      },\n",
                                                    {
                                                        "Fn::If": [
                                                            "IsAgentServer",
                                                            {
                                                                "Fn::Join": [
                                                                    "",
                                                                    [
                                                                        "      {\n",
                                                                        "      \"file_path\": \"",
                                                                        {
                                                                            "Ref": "AppVolumeMountPath"
                                                                        },
                                                                        "/data/agent/logs/agent_wrapper.log\",\n",
                                                                        "      \"log_group_name\": \"",
                                                                        {
                                                                            "Ref": "CollibraLogGroup"
                                                                        },
                                                                        "\",\n",
                                                                        "      \"log_stream_name\": \"collibra_agent_wrapper_logs_{instance_id}\",\n",
                                                                        "      \"timestamp_format\": \"%H:%M:%S %y %b %-d\"\n",
                                                                        "      },\n"
                                                                    ]
                                                                ]
                                                            },
                                                            {
                                                                "Ref": "AWS::NoValue"
                                                            }
                                                        ]
                                                    },
                                                    {
                                                        "Fn::If": [
                                                            "IsConsoleServer",
                                                            {
                                                                "Fn::Join": [
                                                                    "",
                                                                    [
                                                                        "      {\n",
                                                                        "      \"file_path\": \"",
                                                                        {
                                                                            "Ref": "AppVolumeMountPath"
                                                                        },
                                                                        "/data/console/logs/console.log\",\n",
                                                                        "      \"log_group_name\": \"",
                                                                        {
                                                                            "Ref": "CollibraLogGroup"
                                                                        },
                                                                        "\",\n",
                                                                        "      \"log_stream_name\": \"collibra_console_logs_{instance_id}\",\n",
                                                                        "      \"timestamp_format\": \"%H:%M:%S %y %b %-d\"\n",
                                                                        "      },\n"
                                                                    ]
                                                                ]
                                                            },
                                                            {
                                                                "Ref": "AWS::NoValue"
                                                            }
                                                        ]
                                                    },
                                                    {
                                                        "Fn::If": [
                                                            "IsDgcServer",
                                                            {
                                                                "Fn::Join": [
                                                                    "",
                                                                    [
                                                                        "      {\n",
                                                                        "      \"file_path\": \"",
                                                                        {
                                                                            "Ref": "AppVolumeMountPath"
                                                                        },
                                                                        "/data/dgc/logs/dgc.log\",\n",
                                                                        "      \"log_group_name\": \"",
                                                                        {
                                                                            "Ref": "CollibraLogGroup"
                                                                        },
                                                                        "\",\n",
                                                                        "      \"log_stream_name\": \"collibra_dgc_logs_{instance_id}\",\n",
                                                                        "      \"timestamp_format\": \"%H:%M:%S %y %b %-d\"\n",
                                                                        "      },\n",
                                                                        "      {\n",
                                                                        "      \"file_path\": \"",
                                                                        {
                                                                            "Ref": "AppVolumeMountPath"
                                                                        },
                                                                        "/data/dgc/logs/dgc_recommender.log\",\n",
                                                                        "      \"log_group_name\": \"",
                                                                        {
                                                                            "Ref": "CollibraLogGroup"
                                                                        },
                                                                        "\",\n",
                                                                        "      \"log_stream_name\": \"collibra_dgc_recommender_logs_{instance_id}\",\n",
                                                                        "      \"timestamp_format\": \"%H:%M:%S %y %b %-d\"\n",
                                                                        "      },\n",
                                                                        "      {\n",
                                                                        "      \"file_path\": \"",
                                                                        {
                                                                            "Ref": "AppVolumeMountPath"
                                                                        },
                                                                        "/data/dgc/logs/dgc_jobs.log\",\n",
                                                                        "      \"log_group_name\": \"",
                                                                        {
                                                                            "Ref": "CollibraLogGroup"
                                                                        },
                                                                        "\",\n",
                                                                        "      \"log_stream_name\": \"collibra_dgc_jobs_logs_{instance_id}\",\n",
                                                                        "      \"timestamp_format\": \"%H:%M:%S %y %b %-d\"\n",
                                                                        "      },\n"
                                                                    ]
                                                                ]
                                                            },
                                                            {
                                                                "Ref": "AWS::NoValue"
                                                            }
                                                        ]
                                                    },
                                                    {
                                                        "Fn::If": [
                                                            "IsJobServer",
                                                            {
                                                                "Fn::Join": [
                                                                    "",
                                                                    [
                                                                        "      {\n",
                                                                        "      \"file_path\": \"",
                                                                        {
                                                                            "Ref": "AppVolumeMountPath"
                                                                        },
                                                                        "/data/spark-jobserver/logs/spark-job-server.log\",\n",
                                                                        "      \"log_group_name\": \"",
                                                                        {
                                                                            "Ref": "CollibraLogGroup"
                                                                        },
                                                                        "\",\n",
                                                                        "      \"log_stream_name\": \"collibra_spark_logs_{instance_id}\",\n",
                                                                        "      \"timestamp_format\": \"%H:%M:%S %y %b %-d\"\n",
                                                                        "      },\n"
                                                                    ]
                                                                ]
                                                            },
                                                            {
                                                                "Ref": "AWS::NoValue"
                                                            }
                                                        ]
                                                    },
                                                    {
                                                        "Fn::If": [
                                                            "IsMonitoringServer",
                                                            {
                                                                "Fn::Join": [
                                                                    "",
                                                                    [
                                                                        "      {\n",
                                                                        "      \"file_path\": \"",
                                                                        {
                                                                            "Ref": "AppVolumeMountPath"
                                                                        },
                                                                        "/data/agent/logs/agent_wrapper.log\",\n",
                                                                        "      \"log_group_name\": \"",
                                                                        {
                                                                            "Ref": "CollibraLogGroup"
                                                                        },
                                                                        "\",\n",
                                                                        "      \"log_stream_name\": \"collibra_agent_wrapper_logs_{instance_id}\",\n",
                                                                        "      \"timestamp_format\": \"%H:%M:%S %y %b %-d\"\n",
                                                                        "      },\n",
                                                                        "      {\n",
                                                                        "      \"file_path\": \"",
                                                                        {
                                                                            "Ref": "AppVolumeMountPath"
                                                                        },
                                                                        "/data/monitoring/logs/prometheus.log\",\n",
                                                                        "      \"log_group_name\": \"",
                                                                        {
                                                                            "Ref": "CollibraLogGroup"
                                                                        },
                                                                        "\",\n",
                                                                        "      \"log_stream_name\": \"collibra_prometheus_logs_{instance_id}\",\n",
                                                                        "      \"timestamp_format\": \"%H:%M:%S %y %b %-d\"\n",
                                                                        "      },\n"
                                                                    ]
                                                                ]
                                                            },
                                                            {
                                                                "Ref": "AWS::NoValue"
                                                            }
                                                        ]
                                                    },
                                                    "      {\n",
                                                    "      \"file_path\": \"/var/log/watchmaker/watchmaker.log\",\n",
                                                    "      \"log_group_name\": \"",
                                                    {
                                                        "Ref": "CollibraLogGroup"
                                                    },
                                                    "\",\n",
                                                    "      \"log_stream_name\": \"watchmaker_logs_{instance_id}\",\n",
                                                    "      \"timestamp_format\": \"%H:%M:%S %y %b %-d\"\n",
                                                    "      },\n",
                                                    "      {\n",
                                                    "      \"file_path\": \"/var/log/watchmaker/salt_call.debug.log\",\n",
                                                    "      \"log_group_name\": \"",
                                                    {
                                                        "Ref": "CollibraLogGroup"
                                                    },
                                                    "\",\n",
                                                    "      \"log_stream_name\": \"salt_call_debug_logs_{instance_id}\",\n",
                                                    "      \"timestamp_format\": \"%H:%M:%S %y %b %-d\"\n",
                                                    "      }\n",
                                                    "    ]\n",
                                                    "    }\n",
                                                    "  },\n",
                                                    "  \"log_stream_name\": \"default_logs_{instance_id}\"\n",
                                                    "  }\n",
                                                    "}\n"
                                                ]
                                            ]
                                        },
                                        {
                                            "Ref": "AWS::NoValue"
                                        }
                                    ]
                                }
                            }
                        }
                    },
                    "finalize": {
                        "commands": {
                            "10-signal-success": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "cfn-signal -e 0",
                                            " --stack ",
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            " --resource CollibraHost",
                                            {
                                                "Fn::Join": [
                                                    "",
                                                    [
                                                        " --url ",
                                                        "https://cloudformation.",
                                                        {
                                                            "Ref": "AWS::Region"
                                                        },
                                                        ".",
                                                        {
                                                            "Ref": "AWS::URLSuffix"
                                                        }
                                                    ]
                                                ]
                                            },
                                            " --region ",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            "\n"
                                        ]
                                    ]
                                },
                                "ignoreErrors": "true"
                            }
                        }
                    },
                    "install-updates": {
                        "commands": {
                            "10-install-updates": {
                                "command": "yum -y update"
                            }
                        }
                    },
                    "reboot": {
                        "commands": {
                            "10-reboot": {
                                "command": "shutdown -r +1 &"
                            }
                        }
                    },
                    "setup": {
                        "files": {
                            "/etc/cfn/Collibra.envs": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "DGC_CONSOLE_PASSWD=",
                                            {
                                                "Ref": "CollibraConsolePassword"
                                            },
                                            "\n",
                                            "DGC_REPO_PASSWD=",
                                            {
                                                "Ref": "CollibraRepoPassword"
                                            },
                                            "\n",
                                            "DGC_BACKUP_SCHEDULE=",
                                            {
                                                "Ref": "BackupSchedule"
                                            },
                                            "\n",
                                            "DGC_BACKUP_USER_NAME=",
                                            {
                                                "Ref": "BackupUserName"
                                            },
                                            "\n",
                                            "DGC_BACKUP_USER_PASSWORD=",
                                            {
                                                "Ref": "BackupUserPassword"
                                            },
                                            "\n"
                                        ]
                                    ]
                                },
                                "group": "root",
                                "mode": "000640",
                                "owner": "root"
                            },
                            "/etc/cfn/cfn-hup.conf": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "[main]\n",
                                            "stack=",
                                            {
                                                "Ref": "AWS::StackId"
                                            },
                                            "\n",
                                            "region=",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            "\n",
                                            {
                                                "Fn::If": [
                                                    "AssignInstanceRole",
                                                    {
                                                        "Fn::Join": [
                                                            "",
                                                            [
                                                                "role=",
                                                                {
                                                                    "Ref": "InstanceRoleName"
                                                                },
                                                                "\n"
                                                            ]
                                                        ]
                                                    },
                                                    ""
                                                ]
                                            },
                                            {
                                                "Fn::Join": [
                                                    "",
                                                    [
                                                        "url=",
                                                        "https://cloudformation.",
                                                        {
                                                            "Ref": "AWS::Region"
                                                        },
                                                        ".",
                                                        {
                                                            "Ref": "AWS::URLSuffix"
                                                        },
                                                        "\n"
                                                    ]
                                                ]
                                            },
                                            "interval=1",
                                            "\n",
                                            "verbose=true",
                                            "\n"
                                        ]
                                    ]
                                },
                                "group": "root",
                                "mode": "000400",
                                "owner": "root"
                            },
                            "/etc/cfn/hooks.d/cfn-auto-reloader.conf": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "[cfn-auto-reloader-hook]\n",
                                            "triggers=post.update\n",
                                            "path=Resources.CollibraHost.Metadata\n",
                                            "action=cfn-init -v -c update",
                                            " --stack ",
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            " --resource CollibraHost",
                                            {
                                                "Fn::Join": [
                                                    "",
                                                    [
                                                        " --url ",
                                                        "https://cloudformation.",
                                                        {
                                                            "Ref": "AWS::Region"
                                                        },
                                                        ".",
                                                        {
                                                            "Ref": "AWS::URLSuffix"
                                                        }
                                                    ]
                                                ]
                                            },
                                            " --region ",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            "\n",
                                            "runas=root\n"
                                        ]
                                    ]
                                },
                                "group": "root",
                                "mode": "000400",
                                "owner": "root"
                            },
                            "/etc/cfn/scripts/watchmaker-install.sh": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "#!/bin/bash\n\n",
                                            "PYPI_URL=",
                                            {
                                                "Ref": "PypiIndexUrl"
                                            },
                                            "\n",
                                            "# Install pip\n",
                                            "python3 -m ensurepip\n",
                                            "\n",
                                            "# Upgrade pip and setuptools\n",
                                            "python3 -m pip install --index-url=\"$PYPI_URL\" --upgrade pip setuptools\n",
                                            "\n",
                                            "# Install boto3\n",
                                            "python3 -m pip install --index-url=\"$PYPI_URL\" --upgrade boto3\n",
                                            "\n",
                                            "# Install watchmaker\n",
                                            "python3 -m pip install --index-url=\"$PYPI_URL\" --upgrade watchmaker\n"
                                        ]
                                    ]
                                },
                                "group": "root",
                                "mode": "000700",
                                "owner": "root"
                            }
                        },
                        "services": {
                            "sysvinit": {
                                "cfn-hup": {
                                    "enabled": "true",
                                    "ensureRunning": "true",
                                    "files": [
                                        "/etc/cfn/cfn-hup.conf",
                                        "/etc/cfn/hooks.d/cfn-auto-reloader.conf"
                                    ]
                                }
                            }
                        }
                    },
                    "watchmaker-install": {
                        "commands": {
                            "10-watchmaker-install": {
                                "command": "bash -xe /etc/cfn/scripts/watchmaker-install.sh"
                            }
                        }
                    },
                    "watchmaker-launch": {
                        "commands": {
                            "10-watchmaker-launch": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export LC_ALL=en_US.utf-8 && export LANG=en_US.utf-8 && ",
                                            "watchmaker --log-level debug",
                                            " --log-dir /var/log/watchmaker",
                                            " --exclude-states scap*scan",
                                            " --no-reboot",
                                            {
                                                "Fn::If": [
                                                    "UseWamConfig",
                                                    {
                                                        "Fn::Join": [
                                                            "",
                                                            [
                                                                " --config \"",
                                                                {
                                                                    "Ref": "WatchmakerConfig"
                                                                },
                                                                "\""
                                                            ]
                                                        ]
                                                    },
                                                    ""
                                                ]
                                            },
                                            {
                                                "Fn::If": [
                                                    "UseEnvironment",
                                                    {
                                                        "Fn::Join": [
                                                            "",
                                                            [
                                                                " --env \"",
                                                                {
                                                                    "Ref": "WatchmakerEnvironment"
                                                                },
                                                                "\""
                                                            ]
                                                        ]
                                                    },
                                                    ""
                                                ]
                                            },
                                            {
                                                "Fn::If": [
                                                    "UseOuPath",
                                                    {
                                                        "Fn::Join": [
                                                            "",
                                                            [
                                                                " --ou-path \"",
                                                                {
                                                                    "Ref": "WatchmakerOuPath"
                                                                },
                                                                "\""
                                                            ]
                                                        ]
                                                    },
                                                    ""
                                                ]
                                            },
                                            {
                                                "Fn::If": [
                                                    "UseComputerName",
                                                    {
                                                        "Fn::Join": [
                                                            "",
                                                            [
                                                                " --computer-name \"",
                                                                {
                                                                    "Ref": "WatchmakerComputerName"
                                                                },
                                                                "\""
                                                            ]
                                                        ]
                                                    },
                                                    ""
                                                ]
                                            },
                                            {
                                                "Fn::If": [
                                                    "UseAdminGroups",
                                                    {
                                                        "Fn::Join": [
                                                            "",
                                                            [
                                                                " --admin-groups \"",
                                                                {
                                                                    "Ref": "WatchmakerAdminGroups"
                                                                },
                                                                "\""
                                                            ]
                                                        ]
                                                    },
                                                    ""
                                                ]
                                            },
                                            {
                                                "Fn::If": [
                                                    "UseAdminUsers",
                                                    {
                                                        "Fn::Join": [
                                                            "",
                                                            [
                                                                " --admin-users \"",
                                                                {
                                                                    "Ref": "WatchmakerAdminUsers"
                                                                },
                                                                "\""
                                                            ]
                                                        ]
                                                    },
                                                    ""
                                                ]
                                            }
                                        ]
                                    ]
                                }
                            }
                        }
                    },
                    "watchmaker-update": {
                        "commands": {
                            "10-watchmaker-update": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "watchmaker --log-level debug",
                                            " --log-dir /var/log/watchmaker",
                                            " --salt-states None",
                                            " --no-reboot",
                                            {
                                                "Fn::If": [
                                                    "UseWamConfig",
                                                    {
                                                        "Fn::Join": [
                                                            "",
                                                            [
                                                                " --config \"",
                                                                {
                                                                    "Ref": "WatchmakerConfig"
                                                                },
                                                                "\""
                                                            ]
                                                        ]
                                                    },
                                                    ""
                                                ]
                                            },
                                            {
                                                "Fn::If": [
                                                    "UseEnvironment",
                                                    {
                                                        "Fn::Join": [
                                                            "",
                                                            [
                                                                " --env \"",
                                                                {
                                                                    "Ref": "WatchmakerEnvironment"
                                                                },
                                                                "\""
                                                            ]
                                                        ]
                                                    },
                                                    ""
                                                ]
                                            },
                                            {
                                                "Fn::If": [
                                                    "UseOuPath",
                                                    {
                                                        "Fn::Join": [
                                                            "",
                                                            [
                                                                " --oupath \"",
                                                                {
                                                                    "Ref": "WatchmakerOuPath"
                                                                },
                                                                "\""
                                                            ]
                                                        ]
                                                    },
                                                    ""
                                                ]
                                            },
                                            {
                                                "Fn::If": [
                                                    "UseComputerName",
                                                    {
                                                        "Fn::Join": [
                                                            "",
                                                            [
                                                                " --computer-name \"",
                                                                {
                                                                    "Ref": "WatchmakerComputerName"
                                                                },
                                                                "\""
                                                            ]
                                                        ]
                                                    },
                                                    ""
                                                ]
                                            },
                                            {
                                                "Fn::If": [
                                                    "UseAdminGroups",
                                                    {
                                                        "Fn::Join": [
                                                            "",
                                                            [
                                                                " --admin-groups \"",
                                                                {
                                                                    "Ref": "WatchmakerAdminGroups"
                                                                },
                                                                "\""
                                                            ]
                                                        ]
                                                    },
                                                    ""
                                                ]
                                            },
                                            {
                                                "Fn::If": [
                                                    "UseAdminUsers",
                                                    {
                                                        "Fn::Join": [
                                                            "",
                                                            [
                                                                " --admin-users \"",
                                                                {
                                                                    "Ref": "WatchmakerAdminUsers"
                                                                },
                                                                "\""
                                                            ]
                                                        ]
                                                    },
                                                    ""
                                                ]
                                            }
                                        ]
                                    ]
                                }
                            }
                        }
                    }
                }
            },
            "Properties": {
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda1",
                        "Ebs": {
                            "DeleteOnTermination": true,
                            "VolumeSize": {
                                "Ref": "RootVolumeSize"
                            },
                            "VolumeType": "gp2"
                        }
                    },
                    {
                        "Fn::If": [
                            "CreateAppVolume",
                            {
                                "DeviceName": "/dev/xvdf",
                                "Ebs": {
                                    "DeleteOnTermination": true,
                                    "VolumeSize": {
                                        "Ref": "AppVolumeSize"
                                    },
                                    "VolumeType": {
                                        "Ref": "AppVolumeType"
                                    }
                                }
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    }
                ],
                "IamInstanceProfile": {
                    "Fn::If": [
                        "AssignInstanceRole",
                        {
                            "Ref": "InstanceRoleProfile"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "ImageId": {
                    "Ref": "AmiId"
                },
                "InstanceType": {
                    "Ref": "InstanceType"
                },
                "KeyName": {
                    "Fn::If": [
                        "UseKeyPair",
                        {
                            "Ref": "KeyPairName"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "NetworkInterfaces": [
                    {
                        "DeviceIndex": "0",
                        "GroupSet": {
                            "Ref": "SecurityGroupIds"
                        },
                        "SubnetId": {
                            "Ref": "SubnetId"
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    }
                                ]
                            ]
                        }
                    }
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "Content-Type: multipart/mixed; boundary=\"===============3585321300151562773==\"\n",
                                "MIME-Version: 1.0\n",
                                "\n",
                                "--===============3585321300151562773==\n",
                                "Content-Type: text/cloud-config; charset=\"us-ascii\"\n",
                                "MIME-Version: 1.0\n",
                                "Content-Transfer-Encoding: 7bit\n",
                                "Content-Disposition: attachment; filename=\"cloud.cfg\"\n",
                                "\n",
                                "#cloud-config\n",
                                "\n",
                                "system_info:\n",
                                "  default_user:\n",
                                "    name: ",
                                {
                                    "Ref": "ProvisionUser"
                                },
                                "\n",
                                "    selinux_user: unconfined_u\n",
                                "users:\n",
                                "  - default\n",
                                "\n",
                                "hostname: ",
                                {
                                    "Ref": "WatchmakerComputerName"
                                },
                                "\n",
                                "\n",
                                "growpart:\n",
                                "  mode: auto\n",
                                "  devices: [ '/dev/xvda', '/dev/xvda2', '/dev/nvme0n1p2' ]\n",
                                "  ignore_growroot_disabled: false\n",
                                "\n",
                                {
                                    "Fn::If": [
                                        "CreateAppVolume",
                                        {
                                            "Fn::Join": [
                                                "",
                                                [
                                                    "bootcmd:\n",
                                                    "- cloud-init-per instance mkfs-appvolume mkfs -t ext4 ",
                                                    {
                                                        "Fn::If": [
                                                            "SupportsNvme",
                                                            "/dev/nvme1n1",
                                                            "/dev/xvdf"
                                                        ]
                                                    },
                                                    "\n",
                                                    "mounts:\n",
                                                    "- [ ",
                                                    {
                                                        "Fn::If": [
                                                            "SupportsNvme",
                                                            "/dev/nvme1n1",
                                                            "/dev/xvdf"
                                                        ]
                                                    },
                                                    ", ",
                                                    {
                                                        "Ref": "AppVolumeMountPath"
                                                    },
                                                    " , \"auto\", \"defaults,x-initrd.mount\", \"0\", \"0\" ]\n"
                                                ]
                                            ]
                                        },
                                        {
                                            "Ref": "AWS::NoValue"
                                        }
                                    ]
                                },
                                "\n",
                                "--===============3585321300151562773==\n",
                                {
                                    "Fn::If": [
                                        "UseAmiFixer",
                                        {
                                            "Fn::Join": [
                                                "",
                                                [
                                                    "Content-Type: text/x-shellscript; charset=\"us-ascii\"\n",
                                                    "MIME-Version: 1.0\n",
                                                    "Content-Transfer-Encoding: 7bit\n",
                                                    "Content-Disposition: attachment; filename=\"ami_fix_script.sh\"\n",
                                                    "\n",
                                                    "#!/bin/bash -xe\n\n",
                                                    "\n",
                                                    "PATH=\"${PATH}\":/usr/local/bin\n",
                                                    "export PATH\n",
                                                    "\n",
                                                    "if [[ ",
                                                    {
                                                        "Ref": "AmiLocalizerScript"
                                                    },
                                                    " =~ \"http\"* ]]\n",
                                                    "then\n",
                                                    "   install -bDm 0750 <( curl -oL ",
                                                    {
                                                        "Ref": "AmiLocalizerScript"
                                                    },
                                                    " ) /etc/cfn/scripts/ami_fixer\n",
                                                    "elif [[ ",
                                                    {
                                                        "Ref": "AmiLocalizerScript"
                                                    },
                                                    " =~ \"s3:\"* ]]\n",
                                                    "then\n",
                                                    "   install -bDm 0750 <( aws s3 cp ",
                                                    {
                                                        "Ref": "AmiLocalizerScript"
                                                    },
                                                    " - ) /etc/cfn/scripts/ami_fixer\n",
                                                    "fi\n",
                                                    "\n",
                                                    "/etc/cfn/scripts/ami_fixer\n",
                                                    "\n",
                                                    "--===============3585321300151562773==\n",
                                                    "\n"
                                                ]
                                            ]
                                        },
                                        {
                                            "Ref": "AWS::NoValue"
                                        }
                                    ]
                                },
                                "Content-Type: text/x-shellscript; charset=\"us-ascii\"\n",
                                "MIME-Version: 1.0\n",
                                "Content-Transfer-Encoding: 7bit\n",
                                "Content-Disposition: attachment; filename=\"script.sh\"\n",
                                "\n",
                                "#!/bin/bash -xe\n\n",
                                "# Export AWS ENVs\n",
                                "test -r /etc/aws/models/endpoints.json && export AWS_DATA_PATH=/etc/aws/models || true\n",
                                "export AWS_CA_BUNDLE=/etc/pki/tls/certs/ca-bundle.crt\n",
                                "export REQUESTS_CA_BUNDLE=/etc/pki/tls/certs/ca-bundle.crt\n",
                                "export AWS_DEFAULT_REGION=",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n",
                                "export CFN_INIT_URL=",
                                {
                                    "Ref": "CfnInitUrl"
                                },
                                "\n",
                                "\n\n",
                                "# Which aws-cfn-bootstrap to use\n",
                                "if [[ -n ${CFN_INIT_URL} ]]\n",
                                "then\n",
                                "   printf \"Pip-installing aws-cfn-bootstrap... \"\n",
                                "   python3 -m pip install \"${CFN_INIT_URL}\"\n",
                                "\n",
                                "   if [[ $( python3 -m pip list | grep -w aws-cfn-bootstrap > /dev/null )$? -eq 0 ]]\n",
                                "   then\n",
                                "      echo \"Success!\"\n",
                                "\n",
                                "      if [[ ${PATH} == *\"/usr/local/bin\"* ]]\n",
                                "      then\n",
                                "         echo \"Already in PATH\"\n",
                                "      else\n",
                                "         echo \"Adding to PATH\"\n",
                                "         export PATH=\"${PATH}:/usr/local/bin\"\n",
                                "      fi\n",
                                "      chmod 0755 /usr/local/init/redhat/cfn-hup\n",
                                "\n",
                                "      printf \"Creating startup-script... \"\n",
                                "      ln -f -s /usr/local/init/redhat/cfn-hup /etc/rc.d/init.d/cfn-hup || \\\n",
                                "        ( echo \"Failed!\" ; exit 1 )\n",
                                "      chkconfig --add cfn-hup\n",
                                "      chkconfig cfn-hup on\n",
                                "   else\n",
                                "      echo \"pip-install failed\"\n",
                                "      exit 1\n",
                                "   fi\n",
                                "fi\n",
                                "\n",
                                "\n\n",
                                "# Add hostname to /etc/hosts\n",
                                "printf \"%s\t%s\\n\" \"$( hostname -I)\" \"$( hostname )\" >> /etc/hosts\n",
                                "\n",
                                "# Expand root and audit volume (40/60), based on any additional capacity available\n",
                                "# If no addtional space allocated (> 20), command run w/o expanding\n",
                                "# lvextedn command return code is ignored/masked below -- basically brute force\n",
                                "if [[ -x $( which pvs ) ]]\n",
                                "then\n",
                                "   LVMPVS=( $( pvs --noheadings -o pv_name ) )\n",
                                "   for PV in \"${LVMPVS[@]}\"\n",
                                "   do\n",
                                "      pvresize \"${PV}\"\n",
                                "   done\n",
                                "fi\n",
                                "# Brute force expansion of audit/root\n",
                                "lvextend -r -l +40%FREE /dev/VolGroup00/rootVol || true\n",
                                "lvextend -r -l +60%FREE /dev/VolGroup00/auditVol || true\n",
                                "\n",
                                "# Get/Install pip\n",
                                "PYPI_URL=",
                                {
                                    "Ref": "PypiIndexUrl"
                                },
                                "\n",
                                "python3 -m ensurepip\n",
                                "\n",
                                "# Add pip to path\n",
                                "hash pip 2> /dev/null || ",
                                "PATH=\"${PATH}:/usr/local/bin\"",
                                "\n\n",
                                "# Upgrade pip and setuptools\n",
                                "python3 -m pip install --index-url=\"${PYPI_URL}\" --upgrade pip setuptools\n",
                                "\n",
                                "# Fix python urllib3 warnings\n",
                                "yum install -y gcc python-devel libffi-devel openssl-devel\n",
                                "python3 -m pip install",
                                " --index-url=\"${PYPI_URL}\"",
                                " --upgrade cffi\n",
                                "python3 -m pip install",
                                " --index-url=\"${PYPI_URL}\"",
                                " --upgrade pyopenssl ndg-httpsclient pyasn1 'cryptography<2.2;python_version<\"2.7\"' 'cryptography;python_version>=\"2.7\"'",
                                " boto3",
                                "\n\n",
                                "# Which aws-cfn-bootstrap to use\n",
                                "if [[ -n ${CFN_INIT_URL} ]]\n",
                                "then\n",
                                "   printf \"Pip-installing aws-cfn-bootstrap... \"\n",
                                "   python3 -m pip install \"${CFN_INIT_URL}\"\n",
                                "\n",
                                "   if [[ $( python3 -m pip list | grep -w aws-cfn-bootstrap > /dev/null )$? -eq 0 ]]\n",
                                "   then\n",
                                "      echo \"Success!\"\n",
                                "\n",
                                "      if [[ ${PATH} == *\"/usr/local/bin\"* ]]\n",
                                "      then\n",
                                "         echo \"Already in PATH\"\n",
                                "      else\n",
                                "         echo \"Adding to PATH\"\n",
                                "         export PATH=\"${PATH}:/usr/local/bin\"\n",
                                "      fi\n",
                                "      chmod 0755 /usr/local/init/redhat/cfn-hup\n",
                                "\n",
                                "      printf \"Creating startup-script... \"\n",
                                "      ln -f -s /usr/local/init/redhat/cfn-hup /etc/rc.d/init.d/cfn-hup || \\\n",
                                "        ( echo \"Failed!\" ; exit 1 )\n",
                                "      chkconfig --add cfn-hup\n",
                                "      chkconfig cfn-hup on\n",
                                "   else\n",
                                "      echo \"pip-install failed\"\n",
                                "      exit 1\n",
                                "   fi\n",
                                "fi\n",
                                "\n",
                                "# Remove gcc now that it is no longer needed\n",
                                "yum -y remove gcc --setopt=clean_requirements_on_remove=1\n\n",
                                "# Add cfn utils to path\n",
                                "hash cfn-signal 2> /dev/null || ",
                                "PATH=\"${PATH}:/usr/local/bin:/opt/aws/bin\"",
                                "\n\n",
                                "# Execute cfn-init\n",
                                "cfn-init -v -c launch",
                                " --stack ",
                                {
                                    "Ref": "AWS::StackName"
                                },
                                " --resource CollibraHost",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            " --url ",
                                            "https://cloudformation.",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            ".",
                                            {
                                                "Ref": "AWS::URLSuffix"
                                            }
                                        ]
                                    ]
                                },
                                " --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                " ||",
                                " ( echo 'ERROR: cfn-init failed! Aborting!';",
                                " cfn-signal -e 1",
                                "  --stack ",
                                {
                                    "Ref": "AWS::StackName"
                                },
                                "  --resource CollibraHost",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            " --url ",
                                            "https://cloudformation.",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            ".",
                                            {
                                                "Ref": "AWS::URLSuffix"
                                            }
                                        ]
                                    ]
                                },
                                "  --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                ";",
                                " exit 1",
                                " )\n\n",
                                "# Undo disblement of maintenance-user sudoers privs\n",
                                "sed -i '/#.* NOPASSWD/s/^#//' $( find /etc -type f | xargs grep -l NOPASSWD )\n",
                                "\n",
                                "--===============3585321300151562773==--"
                            ]
                        ]
                    }
                }
            },
            "Type": "AWS::EC2::Instance"
        },
        "CollibraLogGroup": {
            "Condition": "InstallCloudWatchAgent",
            "Properties": {
                "LogGroupName": {
                    "Fn::Join": [
                        "",
                        [
                            "/aws/ec2/lx/",
                            {
                                "Ref": "AWS::StackName"
                            }
                        ]
                    ]
                }
            },
            "Type": "AWS::Logs::LogGroup"
        }
    }
}
